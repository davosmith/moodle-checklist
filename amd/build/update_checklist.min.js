define("mod_checklist/update_checklist",["exports","jquery","core/notification"],(function(_exports,_jquery,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Update checklists
   *
   * @module      mod_checklist/update_checklist
   * @copyright   2022 Catalyst IT
   * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_notification=_interopRequireDefault(_notification);let checklists=[],updateList=[],updateTimeout=null,sesskey=null;_exports.init=(cmid,givensesskey,updateprogress)=>{sesskey=givensesskey;let checklist={cmid:cmid,items:[],optionalcount:0,requiredcount:0,requiredchecked:0,optionalchecked:0,updateprogress:updateprogress},items=(0,_jquery.default)('.checklistitem[data-cmid="'+cmid+'"]');for(let i=0;i<items.length;i++){let item=items[i];item.addEventListener("click",checkClicked),item.classList.contains("itemoptional")?(checklist.optionalcount++,item.checked&&checklist.optionalchecked++):(checklist.requiredcount++,item.checked&&checklist.requiredchecked++)}window.addEventListener("visibilitychange",(()=>{sendBatchUpdate(cmid,!0)}),!1),checklists[cmid]=checklist};const checkClicked=event=>{let item=event.currentTarget,cmid=item.dataset.cmid;if(checklists[cmid].updateprogress){let change=item.checked?1:-1;item.classList.contains("itemoptional")?checklists[cmid].optionalchecked+=change:checklists[cmid].requiredchecked+=change,updateProgressBar(cmid)}updateServer(cmid,item.value,item.checked)},updateProgressBar=cmid=>{let checklist=checklists[cmid],prreq=(0,_jquery.default)('.checklistbox[data-cmid="'+cmid+'"] > #checklistprogressrequired'),allpercent=100*(checklist.optionalchecked+checklist.requiredchecked)/(checklist.optionalcount+checklist.requiredcount),inner=(0,_jquery.default)('.checklistbox[data-cmid="'+cmid+'"] #checklistprogressall .checklist_progress_inner')[0],inneranim=(0,_jquery.default)('.checklistbox[data-cmid="'+cmid+'"] #checklistprogressall .checklist_progress_anim')[0],oldpercent=parseFloat(inner.style.width.replace("%",""));if(allpercent>oldpercent?(inneranim.style.width=allpercent+"%",(0,_jquery.default)(inner).animate({width:allpercent+"%"},1e3)):allpercent<oldpercent&&(inner.style.width=allpercent+"%",(0,_jquery.default)(inneranim).animate({width:allpercent+"%"},1e3)),(0,_jquery.default)('.checklistbox[data-cmid="'+cmid+'"] #checklistprogressall .checklist_progress_percent').text(" "+allpercent.toFixed(0)+"% "),prreq.length){let reqpercent=100*checklist.requiredchecked/checklist.requiredcount;inner=(0,_jquery.default)('.checklistbox[data-cmid="'+cmid+'"] #checklistprogressrequired .checklist_progress_inner')[0],inneranim=(0,_jquery.default)('.checklistbox[data-cmid="'+cmid+'"] #checklistprogressrequired .checklist_progress_anim')[0],oldpercent=parseFloat(inner.style.width.replace("%","")),reqpercent>oldpercent?(inneranim.style.width=reqpercent+"%",(0,_jquery.default)(inner).animate({width:reqpercent+"%"},1e3)):reqpercent<oldpercent&&(inner.style.width=reqpercent+"%",(0,_jquery.default)(inneranim).animate({width:reqpercent+"%"},1e3)),(0,_jquery.default)('.checklistbox[data-cmid="'+cmid+'"] #checklistprogressrequired .checklist_progress_percent').text(" "+reqpercent.toFixed(0)+"% ")}},updateServer=(cmid,itemid,state)=>{for(let i=0;i<updateList.length;i++)if(updateList[i].itemid===itemid){if(updateList[i].state!==state){updateList.splice(i,1);break}return}updateList.push({itemid:itemid,state:state}),updateTimeout&&window.clearTimeout(updateTimeout),updateTimeout=window.setTimeout((function(){sendBatchUpdate(cmid,!1)}),500),showSpinner(cmid)},sendBatchUpdate=(cmid,unload)=>{if(updateTimeout&&(window.clearTimeout(updateTimeout),updateTimeout=null),0===updateList.length)return;let params=[];for(let i=0;i<updateList.length;i++)params.push("items["+updateList[i].itemid+"]="+(updateList[i].state?1:0));params.push("sesskey="+sesskey),params.push("id="+cmid);let url=M.cfg.wwwroot+"/mod/checklist/updatechecks.php?"+params.join("&");updateList=[],unload?navigator.sendBeacon(url):_jquery.default.ajax({type:"POST",async:!0,url:url}).then((data=>(hideSpinner(cmid),"OK"!==data&&_notification.default.alert("",data),null))).fail(_notification.default.exception)},hideSpinner=cmid=>{(0,_jquery.default)('#checklistspinner[data-cmid="'+cmid+'"]').hide()},showSpinner=cmid=>{(0,_jquery.default)('#checklistspinner[data-cmid="'+cmid+'"]').show()}}));

//# sourceMappingURL=update_checklist.min.js.map